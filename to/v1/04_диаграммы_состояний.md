# Приложение C. Диаграммы состояний (State Diagrams)

> Диаграммы выполнены в нотации Mermaid.

---

## C.1 Жизненный цикл заказа (Order)

```mermaid
stateDiagram-v2
    [*] --> new : Покупатель подтвердил заказ<br/>(оплата при получении)
    [*] --> awaiting_payment : Покупатель подтвердил заказ<br/>(онлайн-оплата, V2)

    state "Новый (new)" as new
    state "Ожидает оплаты (awaiting_payment)" as awaiting_payment
    state "Оплачен (paid)" as paid
    state "Собирается (assembling)" as assembling
    state "Готов к выдаче (ready)" as ready
    state "Передан курьеру (delivering)" as delivering
    state "Выполнен (completed)" as completed
    state "Отменён (cancelled)" as cancelled

    awaiting_payment --> paid : Платёжный шлюз подтвердил оплату
    awaiting_payment --> cancelled : Покупатель отменил<br/>ИЛИ истекли 24 часа

    new --> assembling : Менеджер взял в сборку
    new --> cancelled : Покупатель отменил<br/>ИЛИ Менеджер отменил

    paid --> assembling : Менеджер взял в сборку
    paid --> cancelled : Покупатель отменил<br/>(инициируется возврат, V2)

    assembling --> ready : Менеджер завершил сборку<br/>(самовывоз)
    assembling --> delivering : Менеджер передал курьеру<br/>(курьерская доставка, V2)
    assembling --> cancelled : Менеджер/Админ отменил<br/>(по запросу клиента или<br/>товар недоступен)

    ready --> completed : Покупатель забрал заказ<br/>Менеджер подтвердил выдачу
    ready --> cancelled : Не забран в течение 7 дней<br/>(автоотмена)

    delivering --> completed : Курьер доставил<br/>Покупатель подтвердил (V2)
    delivering --> ready : Покупатель не на месте<br/>Возврат в ПВЗ (V2)

    completed --> [*]
    cancelled --> [*]
```

### Матрица допустимых переходов статусов

| Текущий статус | Допустимые переходы | Кто может выполнить |
|---------------|--------------------|--------------------|
| **new** (Новый) | → assembling, → cancelled | assembling: Менеджер. cancelled: Покупатель, Менеджер |
| **awaiting_payment** (Ожидает оплаты) | → paid, → cancelled | paid: Система (webhook от шлюза). cancelled: Покупатель, Система (24ч) |
| **paid** (Оплачен) | → assembling, → cancelled | assembling: Менеджер. cancelled: Покупатель (с возвратом), Менеджер |
| **assembling** (Собирается) | → ready, → delivering (V2), → cancelled | ready/delivering: Менеджер. cancelled: Менеджер, Администратор |
| **ready** (Готов к выдаче) | → completed, → cancelled | completed: Менеджер (подтверждение выдачи). cancelled: Система (7 дней) |
| **delivering** (Передан курьеру, V2) | → completed, → ready | completed: Менеджер/Курьер. ready: Менеджер (возврат) |
| **completed** (Выполнен) | - (финальный) | - |
| **cancelled** (Отменён) | - (финальный) | - |

### Автоматические переходы (по расписанию)

| Триггер | Переход | Условие |
|---------|---------|---------|
| Cron-задача, каждые 15 минут | awaiting_payment → cancelled | created_at + 24 часа < текущее время |
| Cron-задача, каждый день в 00:00 | ready → cancelled | ready_at + 7 дней < текущее время |

---

## C.2 Жизненный цикл корзины (Cart)

```mermaid
stateDiagram-v2
    [*] --> empty : Пользователь открыл сайт<br/>(создаётся при первом добавлении)

    state "Пустая (empty)" as empty
    state "Содержит товары (has_items)" as has_items
    state "В процессе оформления (checkout)" as checkout
    state "Заказ создан (ordered)" as ordered
    state "Истекла (expired)" as expired

    empty --> has_items : Добавлен первый товар
    has_items --> has_items : Добавлен / удалён товар<br/>Изменено количество
    has_items --> empty : Удалён последний товар
    has_items --> checkout : Нажата кнопка «Оформить заказ»
    checkout --> has_items : Нажата «Вернуться в корзину»
    checkout --> ordered : Заказ успешно создан
    ordered --> empty : Корзина очищена системой
    has_items --> expired : Неактивна 30 дней (для гостей)
    expired --> [*] : Данные удалены

    ordered --> [*]
```

### Правила истечения корзины

| Тип пользователя | Срок жизни корзины | Действие по истечению |
|-------------------|-------------------|---------------------|
| Гость | 30 дней без активности | Корзина удаляется (cron-задача) |
| Авторизованный | Без ограничений | Не удаляется, но товары могут стать недоступны |

---

## C.3 Жизненный цикл платёжной транзакции (V2)

```mermaid
stateDiagram-v2
    [*] --> pending : Создана при редиректе на шлюз

    state "Ожидает (pending)" as pending
    state "Обработка (processing)" as processing
    state "Успешна (success)" as success
    state "Отклонена (failed)" as failed
    state "Возврат инициирован (refund_pending)" as refund_pending
    state "Возврат выполнен (refunded)" as refunded

    pending --> processing : Шлюз начал обработку
    pending --> failed : Таймаут (15 минут)
    processing --> success : Шлюз подтвердил списание
    processing --> failed : Шлюз отклонил
    success --> refund_pending : Инициирован возврат<br/>(отмена заказа)
    refund_pending --> refunded : Шлюз подтвердил возврат<br/>(3-5 рабочих дней)
    failed --> pending : Повторная попытка<br/>(в течение 24 часов)

    success --> [*]
    refunded --> [*]
    failed --> [*]
```

---

## C.4 Жизненный цикл отзыва (Review, V2)

```mermaid
stateDiagram-v2
    [*] --> pending : Покупатель опубликовал отзыв

    state "На модерации (pending)" as pending
    state "Одобрен (approved)" as approved
    state "Отклонён (rejected)" as rejected

    pending --> approved : Менеджер/Админ одобрил
    pending --> rejected : Менеджер/Админ отклонил
    rejected --> pending : Покупатель отредактировал и переотправил
    approved --> [*]
    rejected --> [*]
```

### Правила модерации

| Правило | Описание |
|---------|----------|
| Автоодобрение | Если текст не содержит стоп-слов и оценка >= 3, отзыв может быть автоматически одобрен (настройка администратора) |
| Срок модерации | Отзыв должен быть рассмотрен в течение 24 часов |
| Причина отклонения | При отклонении менеджер обязан указать причину (спам / нецензурная лексика / не относится к товару / другое) |

---

## C.5 Жизненный цикл пользователя (User)

```mermaid
stateDiagram-v2
    [*] --> guest : Открыл сайт

    state "Гость (guest)" as guest
    state "Зарегистрирован (registered)" as registered
    state "Авторизован (authenticated)" as authenticated
    state "Заблокирован (blocked)" as blocked

    guest --> registered : Успешная регистрация
    guest --> authenticated : После регистрации - автоматически
    registered --> authenticated : Успешный вход (логин)
    authenticated --> registered : Выход (логаут) / истёк токен
    registered --> blocked : Администратор заблокировал
    authenticated --> blocked : Администратор заблокировал
    blocked --> registered : Администратор разблокировал
```

---

## C.6 Жизненный цикл товара в системе (Product)

```mermaid
stateDiagram-v2
    [*] --> draft : Администратор создал товар

    state "Черновик (draft)" as draft
    state "Активен (active)" as active
    state "Нет в наличии (out_of_stock)" as out_of_stock
    state "Деактивирован (inactive)" as inactive
    state "В архиве (archived)" as archived

    draft --> active : Администратор активировал<br/>(все обязательные поля заполнены,<br/>есть хотя бы 1 фото)
    active --> out_of_stock : Все остатки = 0<br/>(автоматически)
    out_of_stock --> active : Поступление на склад<br/>(available > 0, автоматически)
    active --> inactive : Администратор деактивировал
    out_of_stock --> inactive : Администратор деактивировал
    inactive --> active : Администратор активировал
    inactive --> archived : Администратор архивировал
    draft --> archived : Администратор удалил черновик
    archived --> [*]
```

### Правила отображения товара в зависимости от состояния

| Состояние | Виден в каталоге | Карточка доступна | Кнопка «В корзину» |
|-----------|-----------------|-------------------|-------------------|
| **draft** | Нет | Нет | - |
| **active** | Да | Да | Активна |
| **out_of_stock** | Да | Да | Заменена на «Нет в наличии» |
| **inactive** | Нет | Нет (404) | - |
| **archived** | Нет | Нет (404) | - |

---

## C.7 Жизненный цикл промокода (PromoCode, V2)

```mermaid
stateDiagram-v2
    [*] --> created : Администратор создал промокод

    state "Создан (created)" as created
    state "Активен (active)" as active
    state "Исчерпан (exhausted)" as exhausted
    state "Истёк (expired)" as expired
    state "Деактивирован (deactivated)" as deactivated

    created --> active : Наступила дата valid_from
    active --> exhausted : usage_count >= usage_limit
    active --> expired : Наступила дата valid_until
    active --> deactivated : Администратор деактивировал
    deactivated --> active : Администратор активировал<br/>(если valid_until > текущая дата)
    exhausted --> active : Администратор увеличил usage_limit

    expired --> [*]
    exhausted --> [*]
    deactivated --> [*]
```
