# Приложение B. Диаграммы последовательности (Sequence Diagrams)

> Диаграммы выполнены в нотации Mermaid.

---

## B.1 Оформление заказа - полный цикл (V1: самовывоз, оплата при получении)

<div id="seq-order">

```mermaid
sequenceDiagram
    actor User as Покупатель / Гость
    participant FE as Frontend (SPA)
    participant API as API Gateway
    participant CartSvc as Cart Service
    participant ProductSvc as Product Service
    participant OrderSvc as Order Service
    participant StockSvc as Stock Service
    participant NotifySvc as Notification Service
    participant DB as База данных

    Note over User, DB: Шаг 1 - Переход к оформлению

    User->>FE: Нажимает «Оформить заказ»
    FE->>API: GET /api/v1/cart
    API->>CartSvc: Получить корзину
    CartSvc->>DB: SELECT cart + cart_items
    DB-->>CartSvc: Корзина с товарами
    CartSvc->>ProductSvc: Проверить наличие и актуальные цены
    ProductSvc->>StockSvc: GET доступные остатки
    StockSvc->>DB: SELECT stock WHERE available > 0
    DB-->>StockSvc: Остатки
    StockSvc-->>ProductSvc: Остатки по SKU
    ProductSvc-->>CartSvc: Товары с актуальными ценами и наличием
    CartSvc-->>API: Корзина (валидированная)
    API-->>FE: 200 OK - данные корзины
    FE-->>User: Страница «Контактные данные»

    Note over User, DB: Шаг 2 - Заполнение контактных данных

    User->>FE: Заполняет имя, фамилию, email, телефон
    FE->>FE: Клиентская валидация полей
    User->>FE: Нажимает «Далее»
    FE->>FE: Сохраняет данные в state

    Note over User, DB: Шаг 3 - Выбор ПВЗ

    FE->>API: GET /api/v1/pickup-points?city={city}
    API->>ProductSvc: Получить ПВЗ с наличием товаров из корзины
    ProductSvc->>StockSvc: Наличие по каждому ПВЗ
    StockSvc->>DB: SELECT stock GROUP BY pickup_point_id
    DB-->>StockSvc: Остатки по ПВЗ
    StockSvc-->>ProductSvc: Доступность по ПВЗ
    ProductSvc-->>API: Список ПВЗ с информацией о наличии
    API-->>FE: 200 OK - список ПВЗ
    FE-->>User: Карта + список ПВЗ
    User->>FE: Выбирает ПВЗ «Центральный»
    User->>FE: Нажимает «Далее»

    Note over User, DB: Шаг 4 - Выбор способа оплаты

    FE-->>User: V1: «Оплата при получении» (единственный вариант)
    User->>FE: Нажимает «Далее»

    Note over User, DB: Шаг 5 - Подтверждение и создание заказа

    FE-->>User: Сводка заказа
    User->>FE: Нажимает «Подтвердить заказ»
    FE->>API: POST /api/v1/orders
    API->>OrderSvc: Создать заказ

    rect rgb(255, 248, 220)
        Note over OrderSvc, DB: Транзакция создания заказа
        OrderSvc->>StockSvc: Зарезервировать товары на ПВЗ
        StockSvc->>DB: UPDATE stock SET reserved = reserved + qty WHERE available >= qty
        alt Остатки достаточны
            DB-->>StockSvc: OK - зарезервировано
            StockSvc-->>OrderSvc: Резерв успешен
            OrderSvc->>DB: INSERT order (status = 'new')
            OrderSvc->>DB: INSERT order_items
            OrderSvc->>DB: INSERT order_status_history
            DB-->>OrderSvc: Заказ создан
            OrderSvc->>CartSvc: Очистить корзину
            CartSvc->>DB: DELETE cart_items
        else Остатков недостаточно
            DB-->>StockSvc: FAIL - недостаточно
            StockSvc-->>OrderSvc: Ошибка резерва
            OrderSvc-->>API: 409 Conflict - товар недоступен
            API-->>FE: Ошибка - товар недоступен
            FE-->>User: «Количество товара изменилось. Вернитесь в корзину»
        end
    end

    OrderSvc-->>API: 201 Created - order_id, order_number
    API-->>FE: 201 Created
    FE-->>User: Страница «Заказ оформлен» (номер TS-20260209-00042)

    Note over OrderSvc, NotifySvc: Асинхронная отправка уведомления (V2)
    OrderSvc-)NotifySvc: Событие: ORDER_CREATED
    NotifySvc->>NotifySvc: Формирование email
    NotifySvc-)User: Email «Заказ оформлен»
```

---

## B.2 Оформление заказа с онлайн-оплатой (V2)

```mermaid
sequenceDiagram
    actor User as Покупатель
    participant FE as Frontend
    participant API as API Gateway
    participant OrderSvc as Order Service
    participant PaySvc as Payment Service
    participant PayGW as Платёжный шлюз (внешний)
    participant StockSvc as Stock Service
    participant NotifySvc as Notification Service
    participant DB as База данных

    User->>FE: Выбирает «Банковская карта онлайн»
    User->>FE: Нажимает «Подтвердить заказ»
    FE->>API: POST /api/v1/orders (payment_type: card_online)
    API->>OrderSvc: Создать заказ

    OrderSvc->>StockSvc: Зарезервировать товары
    StockSvc->>DB: UPDATE stock (reserve)
    DB-->>StockSvc: OK
    StockSvc-->>OrderSvc: Резерв OK
    OrderSvc->>DB: INSERT order (status = 'awaiting_payment')
    DB-->>OrderSvc: OK

    OrderSvc->>PaySvc: Инициировать платёж (order_id, amount)
    PaySvc->>PayGW: POST /payments/create (amount, return_url, fail_url)
    PayGW-->>PaySvc: payment_url, payment_id
    PaySvc->>DB: INSERT payment_transaction (status = 'pending')
    PaySvc-->>OrderSvc: payment_url
    OrderSvc-->>API: 201 Created {order_id, payment_url}
    API-->>FE: 201 + payment_url
    FE->>User: Редирект на платёжный шлюз

    User->>PayGW: Вводит данные карты, подтверждает
    
    alt Оплата успешна
        PayGW->>PaySvc: POST /webhook/payment (status: success)
        PaySvc->>DB: UPDATE payment_transaction (status = 'success')
        PaySvc->>OrderSvc: Платёж подтверждён (order_id)
        OrderSvc->>DB: UPDATE order (status = 'paid', paid_at = NOW())
        OrderSvc->>DB: INSERT order_status_history
        OrderSvc-)NotifySvc: Событие: ORDER_PAID
        NotifySvc-)User: Email «Оплата получена»
        PayGW->>FE: Редирект на return_url (/checkout/success/{order-id})
        FE-->>User: Страница «Заказ оформлен и оплачен»

    else Оплата отклонена
        PayGW->>PaySvc: POST /webhook/payment (status: failed)
        PaySvc->>DB: UPDATE payment_transaction (status = 'failed')
        PayGW->>FE: Редирект на fail_url (/checkout/payment-failed/{order-id})
        FE-->>User: «Оплата не прошла. Попробуйте снова»
        User->>FE: Нажимает «Повторить оплату»
        FE->>API: POST /api/v1/orders/{id}/retry-payment
        API->>PaySvc: Новая попытка платежа
        PaySvc->>PayGW: POST /payments/create
        PayGW-->>PaySvc: Новый payment_url
        PaySvc-->>API: payment_url
        API-->>FE: payment_url
        FE->>User: Повторный редирект на шлюз
    end

    Note over OrderSvc, DB: Автоматическая отмена через 24 часа
    OrderSvc->>OrderSvc: Cron-задача: проверка неоплаченных заказов
    OrderSvc->>DB: SELECT orders WHERE status='awaiting_payment' AND created_at < NOW()-24h
    OrderSvc->>StockSvc: Снять резерв
    StockSvc->>DB: UPDATE stock SET reserved = reserved - qty
    OrderSvc->>DB: UPDATE order SET status = 'cancelled', cancel_reason = 'Не оплачен в течение 24 часов'
```

---

## B.3 Добавление товара в корзину

```mermaid
sequenceDiagram
    actor User as Пользователь
    participant FE as Frontend
    participant API as API Gateway
    participant CartSvc as Cart Service
    participant ProductSvc as Product Service
    participant StockSvc as Stock Service
    participant DB as База данных

    User->>FE: Нажимает «В корзину» на карточке товара
    FE->>API: POST /api/v1/cart/items {product_id, quantity: 1}
    API->>CartSvc: Добавить товар

    CartSvc->>ProductSvc: Получить информацию о товаре
    ProductSvc->>DB: SELECT product WHERE id = {product_id} AND is_active = true
    DB-->>ProductSvc: Товар (name, price, sku)
    ProductSvc-->>CartSvc: Товар найден

    CartSvc->>StockSvc: Проверить доступный остаток
    StockSvc->>DB: SELECT SUM(available) FROM stock WHERE product_id = {product_id}
    DB-->>StockSvc: available = 15
    StockSvc-->>CartSvc: Остаток: 15

    alt Товар уже в корзине
        CartSvc->>DB: SELECT cart_item WHERE cart_id = X AND product_id = Y
        DB-->>CartSvc: Существует (quantity = 2)
        alt Новый quantity <= available
            CartSvc->>DB: UPDATE cart_item SET quantity = 3
            DB-->>CartSvc: OK
        else Превышает остаток
            CartSvc-->>API: 422 - «Доступно не более 15 шт.»
            API-->>FE: 422
            FE-->>User: Уведомление «Доступно не более 15 шт.»
        end
    else Товара нет в корзине
        CartSvc->>DB: INSERT cart_item (cart_id, product_id, quantity=1, price_at_add)
        DB-->>CartSvc: OK
    end

    CartSvc-->>API: 200 OK {cart_items_count, item}
    API-->>FE: 200 OK
    FE-->>User: Уведомление «Товар добавлен в корзину» + обновление счётчика
```

---

## B.4 Регистрация и авторизация

```mermaid
sequenceDiagram
    actor User as Гость
    participant FE as Frontend
    participant API as API Gateway
    participant AuthSvc as Auth Service
    participant CartSvc as Cart Service
    participant DB as База данных

    Note over User, DB: Регистрация

    User->>FE: Заполняет форму (имя, фамилия, email, телефон, пароль)
    FE->>FE: Клиентская валидация
    FE->>API: POST /api/v1/auth/register
    API->>AuthSvc: Создать пользователя

    AuthSvc->>DB: SELECT user WHERE email = {email}
    alt Email уже существует
        DB-->>AuthSvc: Найден пользователь
        AuthSvc-->>API: 409 Conflict - email занят
        API-->>FE: 409
        FE-->>User: «Пользователь с таким email уже зарегистрирован»
    else Email свободен
        AuthSvc->>DB: SELECT user WHERE phone = {phone}
        alt Телефон занят
            DB-->>AuthSvc: Найден пользователь
            AuthSvc-->>API: 409 Conflict - телефон занят
            API-->>FE: 409
            FE-->>User: «Телефон уже зарегистрирован»
        else Телефон свободен
            AuthSvc->>AuthSvc: Хеширование пароля (bcrypt, cost=12)
            AuthSvc->>DB: INSERT user (role=customer)
            DB-->>AuthSvc: user_id
            AuthSvc->>AuthSvc: Генерация JWT (access: 30 мин, refresh: 30 дней)
            AuthSvc-->>API: 201 Created {user, tokens}

            API->>CartSvc: Перепривязать корзину (session_id → user_id)
            CartSvc->>DB: UPDATE cart SET user_id = {user_id} WHERE session_id = {session}
            DB-->>CartSvc: OK

            API-->>FE: 201 + tokens
            FE->>FE: Сохранить tokens (httpOnly cookie для refresh, memory для access)
            FE-->>User: Перенаправление на предыдущую страницу
        end
    end
```

---

## B.5 Отмена заказа покупателем

```mermaid
sequenceDiagram
    actor User as Покупатель
    participant FE as Frontend
    participant API as API Gateway
    participant OrderSvc as Order Service
    participant StockSvc as Stock Service
    participant PaySvc as Payment Service
    participant PayGW as Платёжный шлюз
    participant NotifySvc as Notification Service
    participant DB as База данных

    User->>FE: Нажимает «Отменить заказ»
    FE-->>User: Модальное окно - выбор причины
    User->>FE: Выбирает «Передумал», подтверждает

    FE->>API: POST /api/v1/orders/{id}/cancel {reason: "Передумал"}
    API->>OrderSvc: Отменить заказ

    OrderSvc->>DB: SELECT order WHERE id = {id}
    DB-->>OrderSvc: Заказ (status, user_id, payment_type)

    alt Статус позволяет отмену (new, paid, awaiting_payment)
        OrderSvc->>DB: UPDATE order SET status = 'cancelled', cancel_reason, cancelled_at
        OrderSvc->>DB: INSERT order_status_history

        OrderSvc->>StockSvc: Снять резерв
        StockSvc->>DB: UPDATE stock SET reserved = reserved - qty (для каждого item)
        DB-->>StockSvc: OK
        StockSvc-->>OrderSvc: Резерв снят

        alt Заказ был оплачен онлайн (V2)
            OrderSvc->>PaySvc: Инициировать возврат (order_id, amount)
            PaySvc->>PayGW: POST /refunds/create
            PayGW-->>PaySvc: refund_id, status: processing
            PaySvc->>DB: INSERT refund_transaction
            PaySvc-->>OrderSvc: Возврат инициирован
        end

        OrderSvc-)NotifySvc: Событие: ORDER_CANCELLED
        NotifySvc-)User: Email «Заказ отменён»

        OrderSvc-->>API: 200 OK
        API-->>FE: 200 OK
        FE-->>User: «Заказ отменён»

    else Статус не позволяет отмену (assembling, ready, delivered, completed)
        OrderSvc-->>API: 422 - отмена невозможна
        API-->>FE: 422
        FE-->>User: «Для отмены обратитесь по телефону 8-800-XXX-XX-XX»
    end
```

---

## B.6 Поиск товаров с подсказками

```mermaid
sequenceDiagram
    actor User as Пользователь
    participant FE as Frontend
    participant API as API Gateway
    participant SearchSvc as Search Service
    participant Cache as Redis Cache
    participant SearchEngine as Elasticsearch

    User->>FE: Вводит «iphone» в строку поиска
    Note over FE: Debounce 300 мс после последнего ввода
    FE->>API: GET /api/v1/search/suggest?q=iphone&limit=5
    API->>SearchSvc: Получить подсказки

    SearchSvc->>Cache: GET suggest:iphone
    alt Кеш найден
        Cache-->>SearchSvc: 5 подсказок
    else Кеш не найден
        SearchSvc->>SearchEngine: Поиск по prefix match
        SearchEngine-->>SearchSvc: Результаты
        SearchSvc->>Cache: SET suggest:iphone (TTL: 5 мин)
    end

    SearchSvc-->>API: [{name, price, image_url, slug}, ...]
    API-->>FE: 200 OK - 5 подсказок
    FE-->>User: Выпадающий список подсказок

    User->>FE: Нажимает Enter
    FE->>API: GET /api/v1/products/search?q=iphone&page=1&limit=24&sort=relevance
    API->>SearchSvc: Полнотекстовый поиск

    SearchSvc->>SearchEngine: Полнотекстовый поиск + фильтры + агрегации
    SearchEngine-->>SearchSvc: {items[], total, facets{}}
    SearchSvc-->>API: Результаты с фасетами
    API-->>FE: 200 OK {products, total, filters, pagination}
    FE-->>User: Страница результатов (товары, фильтры, количество)
```

---

## B.7 Смена статуса заказа менеджером

```mermaid
sequenceDiagram
    actor Manager as Менеджер
    participant FE as Admin Panel
    participant API as API Gateway
    participant OrderSvc as Order Service
    participant NotifySvc as Notification Service
    participant DB as База данных

    Manager->>FE: Открывает заказ TS-20260209-00042
    FE->>API: GET /api/v1/admin/orders/{id}
    API->>OrderSvc: Получить детали заказа
    OrderSvc->>DB: SELECT order + items + status_history
    DB-->>OrderSvc: Данные заказа
    OrderSvc-->>API: Заказ с деталями
    API-->>FE: 200 OK
    FE-->>Manager: Карточка заказа (статус: «Новый»)

    Manager->>FE: Нажимает «Взять в сборку»
    FE->>API: PATCH /api/v1/admin/orders/{id}/status {status: "assembling"}
    API->>OrderSvc: Сменить статус

    OrderSvc->>DB: SELECT order WHERE id = {id}
    DB-->>OrderSvc: status = 'new'
    OrderSvc->>OrderSvc: Проверка допустимости перехода: new -> assembling [OK]
    OrderSvc->>DB: UPDATE order SET status = 'assembling'
    OrderSvc->>DB: INSERT order_status_history (status, changed_by = manager_id)
    DB-->>OrderSvc: OK

    OrderSvc-)NotifySvc: Событие: ORDER_STATUS_CHANGED
    NotifySvc-)NotifySvc: Определить шаблон email для статуса 'assembling'
    NotifySvc-)Manager: - (не уведомляется)
    NotifySvc-)FE: - (не уведомляется на клиенте менеджера)
    Note over NotifySvc: Email покупателю (V2): «Ваш заказ собирается»

    OrderSvc-->>API: 200 OK {order с обновлённым статусом}
    API-->>FE: 200 OK
    FE-->>Manager: Статус обновлён → «Собирается»
```
